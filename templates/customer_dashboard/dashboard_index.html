{% extends "customer_dashboard/base_dashboard.html" %}

{% block dashboard_title %}Resumen del Panel{% endblock %}

{% block dashboard_content %}

    <div class="alert alert-primary border-0" role="alert">
      <h4 class="alert-heading">¡Hola, {{ current_user.username }}! 👋</h4>
      <p class="mb-0">Bienvenido a tu portal de autogestión. Aquí tienes un resumen de tu cuenta.</p>
    </div>

    <h2 class="section-title mt-5"><i class="bi bi-bar-chart-fill me-2"></i>Resumen Rápido</h2>
    <div class="row">
        <div class="col-md-6 col-xl-3 mb-4">
            <a href="#" class="card dashboard-card card-hover-primary h-100 text-decoration-none text-dark bg-primary-subtle border-0">
                <div class="card-body d-flex align-items-center">
                    <i class="bi bi-receipt-cutoff fs-2 text-primary me-3"></i>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">Última Factura</h6>
                        <p class="h5 fw-bold mb-0">$55.000</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-xl-3 mb-4">
            <a href="#" class="card dashboard-card card-hover-success h-100 text-decoration-none text-dark bg-success-subtle border-0">
                <div class="card-body d-flex align-items-center">
                    <i class="bi bi-wallet2 fs-2 text-success me-3"></i>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">Saldo Actual</h6>
                        <p class="h5 fw-bold mb-0">Monto: ${{ "%.2f"|format(total_saldo) }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-xl-3 mb-4">
            <a href="{{ url_for('customer_dashboard.service_management') }}" class="card dashboard-card card-hover-warning h-100 text-decoration-none text-dark bg-warning-subtle border-0">
                <div class="card-body d-flex align-items-center">
                   <i class="bi bi-wifi fs-2 text-warning me-3"></i>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">Servicios</h6>
                        <p class="h5 fw-bold mb-0">{{ servicios_activos_count }} Activos</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-xl-3 mb-4">
            <a href="#" class="card dashboard-card card-hover-danger h-100 text-decoration-none text-dark bg-danger-subtle border-0">
                <div class="card-body d-flex align-items-center">
                   <i class="bi bi-bell-fill fs-2 text-danger me-3"></i>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">Notificaciones</h6>
                        <p class="h5 fw-bold mb-0">2 Pendientes</p>
                    </div>
                </div>
            </a>
        </div>
        
    </div>


    <h2 class="section-title mt-4"><i class="bi bi-box-seam me-2"></i>¿Quieres contratar un nuevo servicio?</h2>
    <div class="card dashboard-card mb-4">
        <a href="{{ url_for('customer_dashboard.customer_contract_service') }}" class="list-group-item list-group-item-action p-3">
            <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1"><i class="bi bi-cart-plus me-2"></i>Contratar Servicio</h5>
                <i class="bi bi-plus-circle fs-4 text-primary"></i>
            </div>
            <p class="mb-1 text-muted">Explora y añade nuevos servicios a tu cuenta.</p>
        </a>
    </div>

    <h2 class="section-title mt-4"><i class="bi bi-gear-fill me-2"></i>Operaciones Técnicas</h2>
    <div class="row">
        <div class="col-lg-4 mb-4">
            <a href="#" class="card dashboard-card h-100 text-decoration-none text-dark">
                <i class="bi bi-chat-left-dots card-corner-icon"></i>
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-envelope-plus me-2"></i>Creá tu reclamo</h5>
                    <p class="card-text text-muted">Ingresá tus reclamos y haz seguimiento.</p>
                </div>
            </a>
        </div>
        <div class="col-lg-4 mb-4">
            <a href="{{ url_for('customer_dashboard.service_management') }}" class="card dashboard-card h-100 text-decoration-none text-dark">
                <i class="bi bi-graph-up card-corner-icon"></i>
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-graph-up me-2"></i>Estado de servicios</h5>
                    <p class="card-text text-muted">Consultá mediciones y el estado actual de tus servicios.</p>
                </div>
            </a>
        </div>
        <div class="col-lg-4 mb-4">
            <a href="#" class="card dashboard-card h-100 text-decoration-none text-dark">
                <i class="bi bi-question-circle card-corner-icon"></i>
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-life-preserver me-2"></i>Otras gestiones</h5>
                    <p class="card-text text-muted">Consultas generales, solicitudes y asistencia.</p>
                </div>
            </a>
        </div>
    </div>

    <h2 class="section-title mt-4"><i class="bi bi-cash-stack me-2"></i>Facturación</h2>
    <div class="row">
        <div class="col-lg-6 mb-4">
            <a href="{{ url_for('customer_dashboard.download_invoice') }}" class="card dashboard-card h-100 text-decoration-none text-dark">
                <i class="bi bi-file-earmark-text card-corner-icon"></i>
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-file-earmark-text me-2"></i>Mi Factura Actual</h5>
                    <p class="card-text text-muted">Descargá tu factura detallada en PDF.</p>
                </div>
            </a>
        </div>
        <div class="col-lg-6 mb-4">
            <a href="#" class="card dashboard-card h-100 text-decoration-none text-dark">
                <i class="bi bi-credit-card card-corner-icon"></i>
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-credit-card-2-front me-2"></i>Medios de pago</h5>
                    <p class="card-text text-muted">Configurá tus formas de pago y realizá pagos en línea.</p>
                </div>
            </a>
        </div>
    </div>
    <h2 class="section-title mt-4"><i class="bi bi-reception-4 me-2"></i>Estado de Servicios</h2>
<div class="card dashboard-card">
    <div class="card-body">
        <canvas id="servicesBarChart"></canvas>
    </div>
</div>

{% block scripts_extra %}
<script>
async function createServicesBarChart() {
    // 1. Pedimos los datos a nuestra nueva API
    const response = await fetch("{{ url_for('customer_dashboard.service_status_chart_api') }}");
    const chartData = await response.json();

    // 2. Lógica para colorear las barras
    // Si el servicio está contratado (valor 1), lo pintamos de azul. Si no (valor 0), de gris.
    const backgroundColors = chartData.is_contracted.map(
        isContracted => isContracted ? 'rgba(13, 110, 253, 0.8)' : 'rgba(200, 200, 200, 0.5)'
    );
    const borderColors = chartData.is_contracted.map(
        isContracted => isContracted ? 'rgba(13, 110, 253, 1)' : 'rgba(200, 200, 200, 1)'
    );

    // 3. Preparamos la configuración del gráfico
    const ctx = document.getElementById('servicesBarChart').getContext('2d');
    const config = {
        type: 'bar', // Tipo de gráfico: barras
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Precio del Servicio ($)',
                data: chartData.prices,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }, // Ocultamos la leyenda, los colores ya son informativos
                title: { display: true, text: 'Servicios Disponibles vs. Contratados' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value, index, values) {
                            return '$' + value.toLocaleString(); // Formato de moneda
                        }
                    }
                }
            }
        },
    };

    // 4. Creamos el gráfico
    new Chart(ctx, config);
}

document.addEventListener('DOMContentLoaded', createServicesBarChart);
</script>

{% endblock %}

{% endblock %}